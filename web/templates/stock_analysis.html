{% extends "base.html" %}

{% block title %}ä¸ªè‚¡åˆ†æ - Daily Stock Analysis{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-8">
    <h1 class="text-2xl font-bold text-white flex items-center mb-2">
        <i class="fa-solid fa-magnifying-glass-chart mr-3 text-blue-500"></i>
        ä¸ªè‚¡åˆ†æ
    </h1>
    <p class="text-slate-400">
        è¾“å…¥è‚¡ç¥¨ä»£ç è¿›è¡Œå®æ—¶åˆ†æï¼Œæ”¯æŒ Aè‚¡ã€æ¸¯è‚¡ã€ç¾è‚¡
    </p>
</div>

<!-- Analysis Input Section -->
<div class="bg-geek-card rounded-xl border border-geek-border p-6 mb-8" x-data="{
    code: '',
    reportType: 'simple',
    loading: false,
    tasks: [],
    MAX_TASKS: 10,
    
    init() {
        this.loadTasks();
        this.startPolling();
    },
    
    validateCode() {
        const code = this.code.trim().toUpperCase();
        const isAStock = /^\d{6}$/.test(code);
        const isHKStock = /^HK\d{5}$/.test(code);
        const isUSStock = /^[A-Z]{1,5}(\.[A-Z]{1,2})?$/.test(code);
        return isAStock || isHKStock || isUSStock;
    },
    
    getCodeType() {
        const code = this.code.trim().toUpperCase();
        if (/^\d{6}$/.test(code)) return 'Aè‚¡';
        if (/^HK\d{5}$/.test(code)) return 'æ¸¯è‚¡';
        if (/^[A-Z]{1,5}(\.[A-Z]{1,2})?$/.test(code)) return 'ç¾è‚¡';
        return '';
    },
    
    async submitAnalysis() {
        if (!this.validateCode() || this.loading) return;
        
        this.loading = true;
        const code = this.code.trim().toUpperCase();
        
        try {
            const response = await fetch(`/analysis?code=${encodeURIComponent(code)}&report_type=${this.reportType}`);
            const data = await response.json();
            
            if (data.success) {
                this.tasks.unshift({
                    task_id: data.task_id,
                    code: code,
                    status: 'running',
                    start_time: new Date().toISOString(),
                    report_type: this.reportType,
                    result: null
                });
                this.tasks = this.tasks.slice(0, this.MAX_TASKS);
                this.saveTasks();
                this.code = '';
            } else {
                alert('æäº¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('è¯·æ±‚å¤±è´¥: ' + error.message);
        } finally {
            this.loading = false;
        }
    },
    
    startPolling() {
        setInterval(() => this.pollTasks(), 3000);
    },
    
    async pollTasks() {
        const runningTasks = this.tasks.filter(t => t.status === 'running' || t.status === 'pending');
        
        for (const task of runningTasks) {
            try {
                const response = await fetch(`/task?id=${encodeURIComponent(task.task_id)}`);
                const data = await response.json();
                
                if (data.success && data.task) {
                    const index = this.tasks.findIndex(t => t.task_id === task.task_id);
                    if (index !== -1) {
                        this.tasks[index] = { ...this.tasks[index], ...data.task };
                        this.saveTasks();
                    }
                }
            } catch (e) {
                console.error('Poll error:', e);
            }
        }
    },
    
    saveTasks() {
        localStorage.setItem('analysis_tasks', JSON.stringify(this.tasks.slice(0, this.MAX_TASKS)));
    },
    
    loadTasks() {
        try {
            const saved = localStorage.getItem('analysis_tasks');
            if (saved) {
                this.tasks = JSON.parse(saved);
            }
        } catch (e) {
            console.error('Load tasks error:', e);
        }
    },
    
    removeTask(taskId) {
        this.tasks = this.tasks.filter(t => t.task_id !== taskId);
        this.saveTasks();
    },
    
    clearCompleted() {
        this.tasks = this.tasks.filter(t => t.status === 'running' || t.status === 'pending');
        this.saveTasks();
    },
    
    formatTime(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    },
    
    calcDuration(start, end) {
        if (!start) return '-';
        const startTime = new Date(start).getTime();
        const endTime = end ? new Date(end).getTime() : Date.now();
        const seconds = Math.floor((endTime - startTime) / 1000);
        if (seconds < 60) return seconds + 's';
        const minutes = Math.floor(seconds / 60);
        const remainSec = seconds % 60;
        return minutes + 'm' + remainSec + 's';
    },
    
    getAdviceClass(advice) {
        if (!advice) return 'bg-slate-700 text-slate-300';
        if (advice.includes('ä¹°') || advice.includes('åŠ ä»“')) return 'bg-green-500/20 text-green-400 border border-green-500/30';
        if (advice.includes('å–') || advice.includes('å‡ä»“')) return 'bg-red-500/20 text-red-400 border border-red-500/30';
        if (advice.includes('æŒæœ‰')) return 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
        return 'bg-slate-700 text-slate-300 border border-slate-600';
    }
}">
    <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="flex-1">
            <label class="block text-sm font-medium text-slate-400 mb-2">è‚¡ç¥¨ä»£ç </label>
            <div class="relative">
                <input 
                    type="text" 
                    x-model="code"
                    @input="code = code.toUpperCase().replace(/[^A-Z0-9.]/g, '').slice(0, 8)"
                    @keydown.enter.prevent="submitAnalysis()"
                    placeholder="Aè‚¡ 600519 / æ¸¯è‚¡ HK00700 / ç¾è‚¡ AAPL"
                    class="w-full bg-slate-900 border border-geek-border rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent font-mono"
                >
                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500" x-show="getCodeType()" x-text="getCodeType()"></div>
            </div>
            <p class="mt-2 text-xs text-slate-500">
                <i class="fa-solid fa-circle-info mr-1"></i>
                Aè‚¡: 6ä½æ•°å­— | æ¸¯è‚¡: HK+5ä½æ•°å­— | ç¾è‚¡: 1-5ä½å­—æ¯
            </p>
        </div>
        <div class="md:w-48">
            <label class="block text-sm font-medium text-slate-400 mb-2">æŠ¥å‘Šç±»å‹</label>
            <select x-model="reportType" class="w-full bg-slate-900 border border-geek-border rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent">
                <option value="simple">ğŸ“ ç²¾ç®€æŠ¥å‘Š</option>
                <option value="full">ğŸ“Š å®Œæ•´æŠ¥å‘Š</option>
            </select>
        </div>
        <div class="md:w-40 flex items-center">
            <button 
                @click="submitAnalysis()"
                :disabled="!validateCode() || loading"
                class="w-full bg-accent hover:bg-accent/80 disabled:bg-slate-700 disabled:cursor-not-allowed text-white font-semibold rounded-lg px-4 py-3 transition-all flex items-center justify-center space-x-2">
                <i class="fa-solid fa-rocket" :class="loading ? 'fa-spin' : ''"></i>
                <span x-text="loading ? 'æäº¤ä¸­...' : 'å¼€å§‹åˆ†æ'"></span>
            </button>
        </div>
    </div>

    <!-- Task List -->
    <div class="border-t border-geek-border pt-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">
                <i class="fa-solid fa-list-check mr-2 text-accent"></i>
                åˆ†æä»»åŠ¡
                <span class="ml-2 text-sm text-slate-400 font-normal" x-text="tasks.length + '/' + MAX_TASKS"></span>
            </h3>
            <button 
                @click="clearCompleted()"
                x-show="tasks.some(t => t.status === 'completed' || t.status === 'failed')"
                class="text-sm text-slate-400 hover:text-white transition-colors">
                <i class="fa-solid fa-broom mr-1"></i> æ¸…ç†å·²å®Œæˆ
            </button>
        </div>

        <div class="space-y-3">
            <template x-if="tasks.length === 0">
                <div class="text-center py-12 text-slate-500">
                    <i class="fa-solid fa-clipboard-list text-4xl mb-3 opacity-50"></i>
                    <p>æš‚æ— åˆ†æä»»åŠ¡ï¼Œè¾“å…¥è‚¡ç¥¨ä»£ç å¼€å§‹åˆ†æ</p>
                </div>
            </template>

            <template x-for="task in tasks" :key="task.task_id">
                <div class="bg-slate-900/50 rounded-lg border border-geek-border p-4 transition-all"
                     :class="{
                         'border-blue-500/30': task.status === 'running',
                         'border-green-500/30': task.status === 'completed',
                         'border-red-500/30': task.status === 'failed'
                     }">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <!-- Status Icon -->
                            <div class="h-10 w-10 rounded-lg flex items-center justify-center"
                                 :class="{
                                     'bg-blue-500/20 text-blue-400': task.status === 'running',
                                     'bg-green-500/20 text-green-400': task.status === 'completed',
                                     'bg-red-500/20 text-red-400': task.status === 'failed',
                                     'bg-slate-700 text-slate-400': task.status === 'pending'
                                 }">
                                <i class="fa-solid" :class="{
                                    'fa-spinner fa-spin': task.status === 'running',
                                    'fa-check': task.status === 'completed',
                                    'fa-xmark': task.status === 'failed',
                                    'fa-clock': task.status === 'pending'
                                }"></i>
                            </div>
                            
                            <!-- Task Info -->
                            <div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-mono font-bold text-white text-lg" x-text="task.code"></span>
                                    <span class="text-xs text-slate-400" x-text="task.report_type === 'full' ? 'å®Œæ•´æŠ¥å‘Š' : 'ç²¾ç®€æŠ¥å‘Š'"></span>
                                </div>
                                <div class="flex items-center space-x-4 text-xs text-slate-500 mt-1">
                                    <span><i class="fa-regular fa-clock mr-1"></i> <span x-text="formatTime(task.start_time)"></span></span>
                                    <span><i class="fa-solid fa-hourglass-half mr-1"></i> <span x-text="calcDuration(task.start_time, task.end_time)"></span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Result -->
                        <div class="flex items-center space-x-3">
                            <template x-if="task.status === 'completed' && task.result">
                                <div class="text-right">
                                    <span class="inline-block px-3 py-1 rounded text-sm font-medium" 
                                          :class="getAdviceClass(task.result.operation_advice)"
                                          x-text="task.result.operation_advice || 'æ— å»ºè®®'"></span>
                                    <div class="text-xs text-slate-500 mt-1" x-text="'è¯„åˆ†: ' + (task.result.sentiment_score || '-') + 'åˆ†'"></div>
                                </div>
                            </template>
                            <template x-if="task.status === 'failed'">
                                <span class="px-3 py-1 rounded text-sm font-medium bg-red-500/20 text-red-400 border border-red-500/30">åˆ†æå¤±è´¥</span>
                            </template>
                            <button @click="removeTask(task.task_id)" class="text-slate-500 hover:text-red-400 transition-colors p-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Expanded Details -->
                    <template x-if="task.status === 'completed' && task.result">
                        <div class="mt-4 pt-4 border-t border-geek-border grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-900 rounded-lg p-3">
                                <div class="text-xs text-slate-500 mb-1">è¶‹åŠ¿é¢„æµ‹</div>
                                <div class="text-sm text-white" x-text="task.result.trend_prediction || '-'"></div>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-3">
                                <div class="text-xs text-slate-500 mb-1">å…³é”®ä»·ä½</div>
                                <div class="text-sm text-white font-mono" x-text="task.result.key_levels || '-'"></div>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-3">
                                <div class="text-xs text-slate-500 mb-1">é£é™©ç­‰çº§</div>
                                <div class="text-sm text-white" x-text="task.result.risk_level || '-'"></div>
                            </div>
                            <div class="md:col-span-3 bg-slate-900 rounded-lg p-3" x-show="task.result.analysis_summary">
                                <div class="text-xs text-slate-500 mb-1">åˆ†ææ‘˜è¦</div>
                                <div class="text-sm text-slate-300 leading-relaxed" x-text="task.result.analysis_summary"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
</div>

<!-- Stock List Configuration -->
<div class="bg-geek-card rounded-xl border border-geek-border p-6" x-data="{
    stockList: '{{ stock_list|default("") }}',
    saving: false,
    message: '',
    messageType: 'success',
    
    async saveConfig() {
        this.saving = true;
        this.message = '';
        
        try {
            const formData = new URLSearchParams();
            formData.append('stock_list', this.stockList);
            
            const response = await fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            
            if (response.ok) {
                this.message = 'ä¿å­˜æˆåŠŸ';
                this.messageType = 'success';
                setTimeout(() => this.message = '', 3000);
            } else {
                throw new Error('ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            this.message = 'ä¿å­˜å¤±è´¥: ' + error.message;
            this.messageType = 'error';
        } finally {
            this.saving = false;
        }
    }
}">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">
            <i class="fa-solid fa-gear mr-2 text-slate-400"></i>
            è‡ªé€‰è‚¡é…ç½®
            <span class="ml-2 text-xs font-normal text-slate-500 bg-slate-800 px-2 py-0.5 rounded">{{ env_filename }}</span>
        </h3>
    </div>
    
    <div class="mb-4">
        <textarea 
            x-model="stockList"
            rows="4"
            placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼Œä¾‹å¦‚: 600519, 000001, HK00700"
            class="w-full bg-slate-900 border border-geek-border rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent font-mono text-sm"
        ></textarea>
        <p class="mt-2 text-xs text-slate-500">
            <i class="fa-solid fa-shield-halved mr-1"></i>
            ä»…ç”¨äºæœ¬åœ°ç¯å¢ƒ (127.0.0.1) å®‰å…¨ä¿®æ”¹ .env é…ç½®
        </p>
    </div>
    
    <div class="flex items-center justify-between">
        <button 
            @click="saveConfig()"
            :disabled="saving"
            class="bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 text-white font-medium rounded-lg px-6 py-2 transition-all flex items-center space-x-2">
            <i class="fa-solid" :class="saving ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            <span x-text="saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜é…ç½®'"></span>
        </button>
        
        <div x-show="message" 
             x-transition
             :class="messageType === 'success' ? 'text-green-400' : 'text-red-400'"
             class="flex items-center text-sm">
            <i class="fa-solid mr-2" :class="messageType === 'success' ? 'fa-check-circle' : 'fa-circle-exclamation'"></i>
            <span x-text="message"></span>
        </div>
    </div>
</div>
{% endblock %}
