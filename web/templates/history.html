{% extends "base.html" %}

{% block title %}ÂéÜÂè≤Êä•Âëä - Daily Stock Analysis{% endblock %}

{% block content %}
<!-- Main Container with Alpine.js Data -->
<div x-data="{
    selectedDate: new Date().toISOString().split('T')[0],
    loading: false,
    reportData: null,
    error: null,
    availableDates: [],
    currentView: 'market',
    
    async init() {
        await this.loadAvailableDates();
        await this.loadReport();
    },
    
    async loadAvailableDates() {
        try {
            const response = await fetch('/api/history/dates');
            const result = await response.json();
            if (result.success && result.dates.length > 0) {
                this.availableDates = result.dates;
                this.selectedDate = result.dates[0];
            }
        } catch (e) {
            console.error('Âä†ËΩΩÂèØÁî®Êó•ÊúüÂ§±Ë¥•:', e);
        }
    },
    
    async loadReport() {
        this.loading = true;
        this.error = null;
        this.reportData = null;
        
        try {
            const response = await fetch(`/api/history/report?date=${this.selectedDate}`);
            const result = await response.json();
            
            if (!response.ok) {
                this.error = result.error || 'Âä†ËΩΩÊä•ÂëäÂ§±Ë¥•';
                this.loading = false;
                return;
            }
            
            if (result.success && result.data) {
                this.reportData = result.data;
            } else {
                this.error = result.error || 'Êú™ÊâæÂà∞ËØ•Êó•ÊúüÁöÑÊä•Âëä';
            }
        } catch (e) {
            this.error = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï';
            console.error('Âä†ËΩΩÊä•ÂëäÂ§±Ë¥•:', e);
        } finally {
            this.loading = false;
        }
    },
    
    getSignalColor(signal) {
        const colors = {
            buy: 'bg-green-500/20 text-green-400 border-green-500/30',
            watch: 'bg-slate-700 text-slate-300 border-slate-600',
            sell: 'bg-red-500/20 text-red-400 border-red-500/30'
        };
        return colors[signal] || colors.watch;
    },
    
    getSignalText(signal) {
        const texts = {
            buy: 'üü¢ Âº∫ÁÉà‰π∞ÂÖ•',
            watch: '‚ö™ ËßÇÊúõ',
            sell: 'üî¥ ÂçñÂá∫'
        };
        return texts[signal] || texts.watch;
    }
}" x-init="init()">

    <!-- Header Section -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-white flex items-center mb-2">
            <i class="fa-solid fa-clock-rotate-left mr-3 text-emerald-500"></i>
            ÂéÜÂè≤Êä•ÂëäÊü•Áúã
        </h1>
        <p class="text-slate-400">
            Êü•ÁúãËøáÂæÄÁöÑÂ∏ÇÂú∫Â§çÁõò‰∏é‰∏™ËÇ°ÂàÜÊûêÊä•Âëä
        </p>
    </div>

    <!-- Date Selector -->
    <div class="bg-geek-card rounded-xl border border-geek-border p-6 mb-8">
        <div class="flex flex-col md:flex-row items-center gap-4">
            <div class="flex items-center space-x-3 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                <span class="text-xs text-slate-400 font-bold uppercase">Êä•ÂëäÊó•Êúü:</span>
                <select 
                    x-model="selectedDate"
                    @change="loadReport()"
                    class="bg-transparent text-white text-sm font-mono focus:outline-none cursor-pointer min-w-[140px]">
                    <template x-for="date in availableDates" :key="date">
                        <option :value="date" x-text="date" class="bg-slate-800"></option>
                    </template>
                </select>
                <span x-show="availableDates.length === 0" class="text-slate-500 text-sm">ÊöÇÊó†ÂéÜÂè≤Êä•Âëä</span>
            </div>
            <button 
                @click="loadReport()"
                :disabled="loading || availableDates.length === 0"
                class="px-6 py-2 bg-accent hover:bg-accent/80 disabled:bg-slate-700 text-white text-sm font-bold rounded-lg transition-all flex items-center">
                <i class="fa-solid fa-rotate mr-2" :class="loading ? 'fa-spin' : ''"></i>
                <span x-text="loading ? 'Âä†ËΩΩ‰∏≠...' : 'Âà∑Êñ∞'"></span>
            </button>
        </div>
        
        <!-- Error Message -->
        <div x-show="error" x-transition class="mt-4 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
            <div class="flex items-center text-red-400">
                <i class="fa-solid fa-circle-exclamation mr-2"></i>
                <span x-text="error"></span>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div x-show="reportData" x-transition>
        <!-- View Switcher -->
        <div class="flex items-center justify-center mb-8">
            <div class="flex items-center space-x-2 bg-slate-800/50 p-1.5 rounded-lg border border-slate-700/50">
                <button 
                    @click="currentView = 'market'"
                    :class="currentView === 'market' ? 'bg-accent text-white border-accent' : 'text-slate-400 hover:text-white border-transparent'"
                    class="px-4 py-2 rounded-md text-sm font-medium border transition-all flex items-center">
                    <i class="fa-solid fa-earth-asia mr-2"></i> Â§ßÁõòÂ§çÁõò
                </button>
                <button 
                    @click="currentView = 'strategy'"
                    :class="currentView === 'strategy' ? 'bg-accent text-white border-accent' : 'text-slate-400 hover:text-white border-transparent'"
                    class="px-4 py-2 rounded-md text-sm font-medium border transition-all flex items-center">
                    <i class="fa-solid fa-crosshairs mr-2"></i> ÂÜ≥Á≠ñÂª∫ËÆÆ
                </button>
            </div>
        </div>

        <!-- Market Review View -->
        <div x-show="currentView === 'market'" x-transition class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa-solid fa-earth-asia mr-3 text-blue-500"></i>
                    Â§ßÁõòÂ§çÁõò
                    <span class="ml-3 text-sm font-normal text-slate-400" x-text="reportData?.date"></span>
                </h2>
            </div>

            <!-- No Market Review Data -->
            <div x-show="!reportData?.marketReview" class="p-8 text-center bg-geek-card rounded-xl border border-geek-border">
                <i class="fa-solid fa-folder-open text-4xl text-slate-600 mb-4"></i>
                <p class="text-slate-400">ËØ•Êó•ÊúüÊöÇÊó†Â§ßÁõòÂ§çÁõòÊï∞ÊçÆ</p>
            </div>

            <div x-show="reportData?.marketReview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Market Summary -->
                <div class="bg-geek-card rounded-xl border border-geek-border p-6 hover:border-accent transition-colors duration-300">
                    <div class="flex items-center mb-4 text-accent">
                        <i class="fa-solid fa-list-check text-lg"></i>
                        <h3 class="ml-2 font-bold uppercase tracking-wider text-sm">Â∏ÇÂú∫ÊÄªÁªì</h3>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-300" x-text="reportData?.marketReview?.summary || 'ÊöÇÊó†Êï∞ÊçÆ'"></p>
                </div>

                <!-- Index Comment -->
                <div class="bg-geek-card rounded-xl border border-geek-border p-6 hover:border-accent transition-colors duration-300">
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fa-solid fa-chart-simple text-lg"></i>
                        <h3 class="ml-2 font-bold uppercase tracking-wider text-sm">ÊåáÊï∞ÁÇπËØÑ</h3>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-300" x-text="reportData?.marketReview?.indexComment || 'ÊöÇÊó†Êï∞ÊçÆ'"></p>
                </div>

                <!-- Capital Flow -->
                <div class="bg-geek-card rounded-xl border border-geek-border p-6 hover:border-accent transition-colors duration-300">
                    <div class="flex items-center mb-4 text-emerald-400">
                        <i class="fa-solid fa-money-bill-transfer text-lg"></i>
                        <h3 class="ml-2 font-bold uppercase tracking-wider text-sm">ËµÑÈáëÂä®Âêë</h3>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-300" x-text="reportData?.marketReview?.capitalFlow || 'ÊöÇÊó†Êï∞ÊçÆ'"></p>
                </div>

                <!-- Hot Topics -->
                <div class="bg-geek-card rounded-xl border border-geek-border p-6 hover:border-accent transition-colors duration-300 lg:col-span-2">
                    <div class="flex items-center mb-4 text-orange-400">
                        <i class="fa-solid fa-fire text-lg"></i>
                        <h3 class="ml-2 font-bold uppercase tracking-wider text-sm">ÁÉ≠ÁÇπËß£ËØª</h3>
                    </div>
                    <p class="text-sm leading-relaxed text-slate-300" x-text="reportData?.marketReview?.hotTopics || 'ÊöÇÊó†Êï∞ÊçÆ'"></p>
                </div>

                <!-- Outlook & Risk -->
                <div class="space-y-6">
                    <div class="bg-geek-card rounded-xl border border-geek-border p-5 border-l-4 border-l-indigo-500">
                        <h3 class="font-bold text-white mb-2 text-sm flex items-center">
                            <i class="fa-solid fa-binoculars mr-2"></i> ÂêéÂ∏ÇÂ±ïÊúõ
                        </h3>
                        <p class="text-xs text-slate-400 leading-relaxed" x-text="reportData?.marketReview?.outlook || 'ÊöÇÊó†Êï∞ÊçÆ'"></p>
                    </div>

                    <div class="bg-geek-card rounded-xl border border-geek-border p-5 border-l-4 border-l-red-500 bg-red-900/10">
                        <h3 class="font-bold text-red-400 mb-2 text-sm flex items-center">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i> È£éÈô©ÊèêÁ§∫
                        </h3>
                        <p class="text-xs text-slate-400 leading-relaxed" x-text="reportData?.marketReview?.riskWarning || 'ÊöÇÊó†Êï∞ÊçÆ'"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy View -->
        <div x-show="currentView === 'strategy'" x-transition class="space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa-solid fa-crosshairs mr-3 text-green-500"></i>
                    ÂÜ≥Á≠ñÂª∫ËÆÆ
                </h2>
                <div class="flex space-x-2 text-xs font-mono font-bold" x-show="reportData?.decisions?.length > 0">
                    <span class="px-2 py-1 rounded bg-green-500/20 text-green-400 border border-green-500/30">
                        ‰π∞ÂÖ•: <span x-text="reportData?.decisions?.filter(d => d.signal === 'buy').length || 0"></span>
                    </span>
                    <span class="px-2 py-1 rounded bg-slate-700 text-slate-300 border border-slate-600">
                        ËßÇÊúõ: <span x-text="reportData?.decisions?.filter(d => d.signal === 'watch').length || 0"></span>
                    </span>
                    <span class="px-2 py-1 rounded bg-red-500/20 text-red-400 border border-red-500/30">
                        ÂçñÂá∫: <span x-text="reportData?.decisions?.filter(d => d.signal === 'sell').length || 0"></span>
                    </span>
                </div>
            </div>

            <!-- No Decisions Data -->
            <div x-show="!reportData?.decisions || reportData?.decisions?.length === 0" class="p-8 text-center bg-geek-card rounded-xl border border-geek-border">
                <i class="fa-solid fa-clipboard-list text-4xl text-slate-600 mb-4"></i>
                <p class="text-slate-400">ËØ•Êó•ÊúüÊöÇÊó†ÂÜ≥Á≠ñÂª∫ËÆÆÊï∞ÊçÆ</p>
            </div>

            <div class="space-y-6">
                <template x-for="(stock, index) in reportData?.decisions" :key="stock.code">
                    <div class="bg-geek-card rounded-xl border overflow-hidden transition-all hover:border-slate-500"
                         :class="stock.signal === 'buy' ? 'border-green-500/50 shadow-lg shadow-green-900/10' : 'border-geek-border'">
                        <!-- Header -->
                        <div class="p-6 border-b border-geek-border flex flex-col md:flex-row md:items-center justify-between gap-4"
                             :class="stock.signal === 'buy' ? 'bg-green-500/5' : 'bg-slate-800/50'">
                            <div class="flex items-center">
                                <div class="h-12 w-12 rounded-lg flex items-center justify-center mr-4 border"
                                     :class="stock.signal === 'buy' ? 'bg-green-500/20 text-green-400 border-green-500/30' : 'bg-slate-700 text-slate-400 border-slate-600'">
                                    <i class="fa-solid text-xl" :class="stock.signal === 'buy' ? 'fa-arrow-trend-up' : 'fa-eye'"></i>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">
                                        <span x-text="stock.name"></span>
                                        <span class="text-lg text-slate-500 font-mono ml-2" x-text="'(' + stock.code + ')'"></span>
                                    </h3>
                                    <div class="flex items-center gap-3 mt-1">
                                        <span class="text-xs font-bold px-2 py-0.5 rounded border" 
                                              :class="getSignalColor(stock.signal)"
                                              x-text="getSignalText(stock.signal)"></span>
                                        <span class="text-xs font-mono text-slate-400">ËØÑÂàÜ: <span class="text-white" x-text="stock.score"></span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-black/40 rounded-lg p-4 border md:max-w-md w-full"
                                 :class="stock.signal === 'buy' ? 'border-green-500/20' : 'border-geek-border'">
                                <h4 class="text-xs uppercase text-slate-500 mb-1 font-bold">ÂÜ≥Á≠ñÊåá‰ª§</h4>
                                <p class="font-mono text-sm border-l-2 pl-3"
                                   :class="stock.signal === 'buy' ? 'text-green-400 border-green-500' : 'text-slate-300 border-slate-500'"
                                   x-text="stock.decision"></p>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-geek-border">
                            <!-- Fundamentals -->
                            <div class="p-6 space-y-6">
                                <div>
                                    <h4 class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-3">Âü∫Êú¨Èù¢</h4>
                                    <ul class="space-y-3 text-sm">
                                        <template x-for="item in stock.fundamentals" :key="item">
                                            <li class="flex items-start">
                                                <i class="fa-solid fa-comment-dots mt-1 mr-2 text-blue-400"></i>
                                                <span class="text-slate-300" x-text="item"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>

                            <!-- Data -->
                            <div class="p-6 space-y-6">
                                <div>
                                    <h4 class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-3">Êï∞ÊçÆÈÄèËßÜ</h4>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div class="bg-slate-900 p-3 rounded border border-geek-border">
                                            <div class="text-xs text-slate-500">ÂΩìÂâç‰ª∑</div>
                                            <div class="text-lg font-mono text-white" x-text="stock.price"></div>
                                        </div>
                                        <div class="bg-slate-900 p-3 rounded border border-geek-border">
                                            <div class="text-xs text-slate-500">‰πñÁ¶ªÁéá</div>
                                            <div class="text-lg font-mono" 
                                                 :class="stock.bias > 0 ? 'text-green-400' : 'text-red-400'"
                                                 x-text="(stock.bias > 0 ? '+' : '') + stock.bias + '%'"></div>
                                        </div>
                                    </div>
                                    <div class="space-y-1 text-xs font-mono">
                                        <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                                            <div class="h-1.5 rounded-full transition-all duration-500"
                                                 :class="stock.trend > 70 ? 'bg-green-500' : stock.trend > 40 ? 'bg-yellow-500' : 'bg-red-500'"
                                                 :style="'width: ' + stock.trend + '%'"></div>
                                        </div>
                                        <div class="text-right" 
                                             :class="stock.trend > 70 ? 'text-green-500' : stock.trend > 40 ? 'text-yellow-500' : 'text-red-500'"
                                             x-text="'Ë∂ãÂäøÂº∫Â∫¶: ' + stock.trend + '%'"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Suggestion -->
                            <div class="p-6 bg-slate-800/30">
                                <h4 class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-3">Êìç‰ΩúÂª∫ËÆÆ</h4>
                                <div class="p-3 bg-slate-900 rounded border border-geek-border text-sm">
                                    <span class="block text-slate-500 font-bold mb-1">üÜï Á©∫‰ªìËÄÖ</span>
                                    <p class="text-slate-300" x-text="stock.suggestion"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

</div>
{% endblock %}
