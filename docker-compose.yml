# ===================================
# A股自選股智能分析系統 - Docker Compose
# ===================================
# 
# 使用方式:
#   定時模式: docker-compose up -d
#   WebUI模式: docker-compose up -d webui
#   同時啟動: docker-compose up -d analyzer webui

version: '3.8'

x-common: &common
  build:
    context: .
    dockerfile: Dockerfile
  restart: unless-stopped

  # 環境變量（從 .env 文件加載）
  env_file:
    - .env

  volumes:
    - ./data:/app/data
    - ./logs:/app/logs
    - ./reports:/app/reports
    - ./.env:/app/.env

  environment:
    - TZ=Asia/Shanghai

    # 注意：容器內如果綁定到 127.0.0.1，宿主機端口映射將無法訪問 WebUI。
    # 即使 .env 裡設置了 WEBUI_HOST=127.0.0.1，這裡也會強制覆蓋。
    - WEBUI_HOST=0.0.0.0
    - WEBUI_PORT=8000

    # 代理設置（如果需要）
    # - http_proxy=http://host.docker.internal:10809
    # - https_proxy=http://host.docker.internal:10809
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  # 資源限制
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M

services:
  # 定時任務模式
  analyzer:
    <<: *common
    container_name: stock-analyzer

  # WebUI 模式
  webui:
    <<: *common
    container_name: stock-webui
    command: ["python", "main.py", "--webui-only"]
    ports:
      - "8000:8000"
